#!/usr/bin/env expect
#!/usr/bin/expect

# 1. ë¡œê·¸ íŒŒì¼ ì„¤ì •
set log_filename "debug.log"
set log_file [open $log_filename "w"]

proc log_debug {msg} {
    global log_file
    puts $log_file $msg
    flush $log_file
}

# ==========================================
# ğŸ§¹ [NEW] ë²„í¼ ì„¸íƒê¸° (ANSI -> ê³µë°± ì¹˜í™˜)
# ==========================================
proc clean_buffer_ansi {str} {
    # 1. ANSI CSI ì‹œí€€ìŠ¤ (ESC [ ... ë¬¸ì) ì œê±°
    # ì—¬ê¸°ì„œ ""(ì‚­ì œ)ê°€ ì•„ë‹ˆë¼ " "(ê³µë°±)ìœ¼ë¡œ ì¹˜í™˜í•˜ëŠ” ê²Œ í•µì‹¬!
    # ì˜ˆ: "user^[[20Ggame" -> "user game" (ë¶„ë¦¬ë¨)
    regsub -all {\x1b\[[0-9;]*[a-zA-Z]} $str " " cleaned

    # 2. ê¸°íƒ€ ì¡ë‹¤í•œ ì œì–´ë¬¸ìë“¤ (í˜¹ì‹œ ëª¨ë¥¼ í°íŠ¸ì„¤ì • ë“±) ì œê±°
    regsub -all {\x1b[\(\)][A-Z0-9]} $cleaned " " cleaned
    
    # 3. ì¤‘ë³µ ê³µë°± ì •ë¦¬ (ìŠ¤í˜ì´ìŠ¤ë°” ì—¬ëŸ¬ ê°œë¥¼ í•œ ê°œë¡œ) -> íŒŒì‹± ì˜ˆì˜ê²Œ í•˜ë ¤ê³ 
    regsub -all {\s+} $cleaned " " final
    return $final
}

# ì°¨ë‹¨ ëª©ë¡
set perm_blacklist {
    "CNCPublicChat" "Sequell" "Cheibriados" 
    "Gozag" "Qazlal" "Beogh" "Yiuf"
}

set recent_history {}
set history_limit 5
set timeout 30
match_max 100000 

set ssh_cmd "env TERM=xterm-256color ssh -p 1326 -oPubkeyAcceptedKeyTypes=+ssh-rsa -oHostKeyAlgorithms=+ssh-rsa nemelex@crawl.nemelex.cards"

puts "ğŸš€ Nemelex ë°°ê²½ ê´€ì „ê¸° (Clean Buffer Architecture)"
log_debug "=== ì‹œì‘ ==="

spawn {*}$ssh_cmd

expect {
    "yes/no" { send "yes\r"; exp_continue }
    "password:" { send "xobeh\r" }
    "dgamelaunch" { }
    timeout { puts "âŒ ì ‘ì† ì‹¤íŒ¨"; exit }
}

while {1} {
    expect {
        -re "=>" {
            # 1. ì›ë³¸ ë²„í¼ ê°€ì ¸ì˜¤ê¸°
            set raw_buffer $expect_out(buffer)

            if {![string match "*Watch which game?*" $raw_buffer]} {
                log_debug "\[INFO\] ë©”ì¸ ë©”ë‰´ -> 'w' ì…ë ¥"
                send "w"
                sleep 0.5
                exp_continue
            }

            # 2. [í•µì‹¬] ë²„í¼ ì²­ì†Œ! (ì´ì œ clean_bufferì—” ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ìˆìŒ)
            set clean_buffer [clean_buffer_ansi $raw_buffer]
            log_debug "buffer = $clean_buffer"
            # ë¡œê·¸ì— ì²­ì†Œëœ ë²„í¼ë¥¼ ì°ì–´ë³´ë©´ ì–¼ë§ˆë‚˜ ê¹”ë”í•œì§€ ë³´ì…ë‹ˆë‹¤.
            # log_debug "--- CLEAN BUFFER ---\n$clean_buffer"

            set target_key ""
            set backup_key ""
            set target_username ""
            set backup_username ""

            foreach char {a b c d e f g h i j k l m n o p q r s t u v w x y z} {
                
                # 3. íŒŒì‹± (ì´ì œ ì•„ì£¼ ê°„ë‹¨í•œ ì •ê·œì‹ìœ¼ë¡œ ê°€ëŠ¥)
                # ${char}) ë’¤ì— ê³µë°±, ê·¸ ë’¤ì— ì•„ì´ë””(\S+), ... 80x 24 ...
                
                if {[regexp "${char}\\)\\s(\\S+)\\s\\S+\\s+L\\d+\\s+\\S{4},\\s+\\S+\\s+80x 24\\s*(\[0-9msh\\s\]*)\\s\\d+" $clean_buffer match username idle_part]} {
                    log_debug "match: $match\n username: $username\n idle_part: $idle_part\n"
                    # ì´ë¯¸ ìœ„ì—ì„œ ì²­ì†Œë¥¼ ë‹¤ í–ˆìœ¼ë¯€ë¡œ strip_ansi í˜¸ì¶œ ë¶ˆí•„ìš”!
                    # ë°”ë¡œ ë¡œì§ ìˆ˜í–‰
                    
                    if {$username == ""} { continue }

                    # ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì²´í¬
                    if {[lsearch -exact $perm_blacklist $username] != -1} {
                        log_debug "SKIP: '$username' (ë´‡)"
                        continue
                    }

                    # íˆìŠ¤í† ë¦¬ ì²´í¬
                    if {[lsearch -exact $recent_history $username] != -1} {
                        log_debug "SKIP: '$username' (ìµœê·¼ ë³¸ ìœ ì €)"
                        continue
                    }

                    # Idle ì²´í¬ (ì´ë¯¸ clean_bufferë¼ ì¡ë¬¸ì ì—†ìŒ)
                    set idle_str [string trim $idle_part]
                    
                    if {[regexp {[0-9]+[mh]} $idle_str]} {
                        log_debug "SKIP: '$username' (1ë¶„ ì´ìƒ ì ìˆ˜)"
                        continue
                    } elseif {[regexp {[0-9]+s} $idle_str]} {
                        if {$backup_key == ""} {
                            log_debug "ì˜ˆë¹„ ëŒ€ê¸° ìœ ì €: '$username'"
                            set backup_key $char
                            set backup_username $username
                        }
                    } else {
                        log_debug "Target found: '$username'"
                        set target_key $char
                        set target_username $username
                        break
                    }
                }
            }

            # ì§„ì… ë¡œì§ (ì´í•˜ ë™ì¼)
            if {$target_key == "" && $backup_key == ""} {
                log_debug "ìœ ì € ë¯¸ë°œê²¬, ëŒ€ê¸°."
                if {[llength $recent_history] > 0} {
                    puts "\nğŸ”„ ê¸°ë¡ ë¦¬ì…‹."
                    set recent_history {}
                    sleep 1
                    send " "
                    exp_continue
                } else {
                    puts "\nğŸ’¤ ëŒ€ê¸° (5ì´ˆ)."
                    sleep 5
                    send " "
                    exp_continue
                }
            }

            if {$target_key == "" && $backup_key != ""} {
                log_debug "\nğŸ¥ˆ ì°¨ìˆœìœ„ ì§„ì… ($backup_username)"
                set target_key $backup_key
                set target_username $backup_username
            } elseif {$target_key != ""} {
                log_debug "\nğŸ¥‡ ìœ ì € ì§„ì… ($target_username)"
            }

            if {$target_key != ""} {
                lappend recent_history $target_username
                if {[llength $recent_history] > $history_limit} {
                    set recent_history [lrange $recent_history 1 end]
                }

                send "$target_key"
                expect_user -re "(.*)"
                
                interact {
                    -o 
                    "=>" { return }
                    "You die..." { send "q"; return }
                    "You have escaped!" { send "q"; return }
                    "Connection to" { exit }
                    -t 30 {
                        log_debug "\nì ìˆ˜ â± 30ì´ˆ ê²½ê³¼. íƒˆì¶œ"
                        send "q"
                        return
                    }
                }
            }
        }
        "connection closed" { log_debug "ì—°ê²° ëŠê¹€" exit }
        timeout { log_debug "â± íƒ€ì„ì•„ì›ƒ"; exit }
    }
}
